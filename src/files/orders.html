<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Admin ‚Äì Orders</title>
  <meta content="width=device-width, initial-scale=1.0" name="viewport" />

  <style>
      * {
          box-sizing: border-box;
          font-family: Arial, sans-serif;
      }

      body {
          background: #f4f6f8;
          padding: 16px;
          margin: 0;
      }

      h1 {
          margin-bottom: 12px;
      }

      .password {
          width: 100%;
          padding: 10px;
          border-radius: 6px;
          border: 1px solid #ccc;
          margin-bottom: 16px;
      }

      /* ================= ORDER CARD BASE ================= */
      .order {
          border-radius: 12px;
          padding: 16px;
          margin-bottom: 16px;
          box-shadow: 0 2px 6px rgba(0, 0, 0, .1);
          border-left: 6px solid transparent;
      }

      /* ================= ORDER STATES ================= */

      /* üîµ Unaccepted */
      .order-unaccepted {
          background: #eff6ff;
          border-left-color: #2563eb;
          animation: pulse 2s infinite;
      }

      /* üü° Accepted */
      .order-accepted {
          background: #fff7ed;
          border-left-color: #f59e0b;
      }

      /* üü¢ Delivered */
      .order-delivered {
          background: #ecfdf5;
          border-left-color: #22c55e;
          opacity: 0.9;
      }

      /* Pulse animation */
      @keyframes pulse {
          0% {
              box-shadow: 0 0 0 0 rgba(37, 99, 235, .4);
          }
          70% {
              box-shadow: 0 0 0 8px rgba(37, 99, 235, 0);
          }
          100% {
              box-shadow: 0 0 0 0 rgba(37, 99, 235, 0);
          }
      }

      /* ================= COMMON ================= */
      .order-header {
          display: flex;
          justify-content: space-between;
          align-items: center;
      }

      .badge {
          padding: 4px 10px;
          border-radius: 12px;
          font-size: 12px;
          color: white;
      }

      .status-pending {
          background: #f59e0b;
      }

      .status-delivered {
          background: #22c55e;
      }

      .meta {
          font-size: 14px;
          margin-top: 4px;
      }

      button, select {
          width: 100%;
          padding: 10px;
          border-radius: 6px;
          border: none;
          margin-top: 8px;
          cursor: pointer;
      }

      .accept-btn {
          background: #2563eb;
          color: white;
      }

      .map-btn {
          background: #16a34a;
          color: white;
      }

      .items {
          margin-top: 12px;
          border-top: 1px dashed #ddd;
          padding-top: 12px;
      }

      .item {
          display: flex;
          gap: 10px;
          margin-bottom: 10px;
      }

      .item img {
          width: 60px;
          height: 60px;
          border-radius: 6px;
          object-fit: cover;
      }

      .category {
          font-size: 12px;
          background: #e5e7eb;
          padding: 2px 8px;
          border-radius: 6px;
      }

      /* ================= MODAL ================= */
      .modal {
          position: fixed;
          inset: 0;
          background: rgba(0, 0, 0, .4);
          display: none;
          justify-content: center;
          align-items: center;
      }

      .modal-content {
          background: #fff;
          padding: 16px;
          border-radius: 12px;
          width: 280px;
      }

      .chips {
          display: flex;
          gap: 8px;
          margin-top: 12px;
      }

      .chip {
          background: #e0f2fe;
          padding: 6px 12px;
          border-radius: 16px;
          cursor: pointer;
      }

      .close-btn {
          cursor: pointer;
          font-size: 18px;
      }
  </style>
</head>

<body>

<h1>üì¶ Orders</h1>
<h2><a href="/files/products.html">Products</a></h2>
<input class="password" id="adminPassword" placeholder="Admin Password" type="password">
<div class="filter-bar" id="filterBar" style="display:none">
  <button class="filter-btn" onclick="clearUserFilter()">‚¨Ö Show All Orders</button>
</div>
<div id="orders"></div>

<!-- MODAL -->
<div class="modal" id="acceptModal" onclick="closeModalOutside(event)">
  <div class="modal-content">
    <div style="display:flex;justify-content:space-between;">
      <strong>Select Delivery Person</strong>
      <span class="close-btn" onclick="closeModal()">‚úñ</span>
    </div>
    <div class="chips" id="deliveryUsers"></div>
  </div>
</div>

<!-- SOUNDS -->
<audio id="normalSound" src="https://actions.google.com/sounds/v1/alarms/bugle_tune.ogg"></audio>
<audio id="highSound" src="https://actions.google.com/sounds/v1/alarms/alarm_clock.ogg"></audio>

<script>
  const API = '/orders';
  const deliveryUsers = [{ name: 'Akash', mobile: '9876543210' }, { name: 'Boby', mobile: '7988620067' }];
  const HIGH_VALUE = 500;
  let selectedOrderId = null;

  async function loadOrders() {
    const pass = localStorage.getItem('admin_pass');
    if (pass) document.getElementById('adminPassword').value = pass;
    const res = await fetch(API);
    let orders = await res.json();
    const container = document.getElementById('orders');
    container.innerHTML = '';

    let beep = false, highBeep = false;

    const newOrders = selectedUserId
      ? orders.filter(o => o.userId === selectedUserId)
      : orders;

    document.getElementById('filterBar').style.display =
      selectedUserId ? 'block' : 'none';

    newOrders.reverse().forEach(order => {
      let stateClass = 'order-unaccepted';

      if (order.status === 'delivered') {
        stateClass = 'order-delivered';
      } else if (order.orderAcceptedBy) {
        stateClass = 'order-accepted';
      } else {
        if (order.netPrice >= HIGH_VALUE) highBeep = true;
        else beep = true;
      }

      const div = document.createElement('div');
      div.className = `order ${stateClass}`;

      const acceptSection = !order.orderAcceptedBy
        ? `<button class="accept-btn" onclick="openModal('${order._id}')">üö¥ Accept Order</button>`
        : `<div class="meta"><b>Accepted by:</b> ${deliveryUsers.find(u => u.mobile === order.orderAcceptedBy).name}</div>`;

      div.innerHTML = `
      <div class="order-header">
      <h3 onclick="filterByUser(${order.userId})" style="cursor: pointer;">UserId - <strong style="color: blue">${order.userId}</strong></h3>
        <strong>${order.customerName}</strong>
        <span class="badge status-${order.status}">${order.status}</span>
      </div>

      <div class="meta">üìû <a href="tel:${order.phone}">${order.phone}</a></div>
      <div class="meta">üìç ${order.address}</div>

      ${order.lat ? `<button class="map-btn" onclick="openMap(${order.lat},${order.lng})">üìç View on Map</button>` : ''}

      ${acceptSection}

      <div class="items">
        ${order.items.map(i => `
          <div class="item">
            <img src="${i.productImage}">
            <div>
              <b>${i.productName}</b>
              <div>${i.productDescription}</div>
              <div class="category">${i.productCategory}</div>
              <div>Qty: ${i.qty} √ó ‚Çπ${i.price}</div>
            </div>
          </div>`).join('')}
      </div>
      <p>Total Online Paid Amount: ‚Çπ${order.onlinePaidAmount}</p>
      <p>Total Online Paid Amount Staus: ${order.onlinePaymentStatus}</p>
      <p>Total Balance Amount: ‚Çπ${order.netPrice - order.onlinePaidAmount}</p>
      <a href="${order.paymentScreenShot}" target="_blank"><img src="${order.paymentScreenShot}" alt="paymentScreenShot" width="50" height="50"></a>
      <br>
      <b>Total: ‚Çπ${order.netPrice}</b>

      <select onchange="updateStatus('${order._id}',this.value)">
        ${['pending', 'preparing', 'outForDelivery', 'delivered', 'returned', 'cancelled', 'cancelledByCustomer', 'cancelledByRestaurant']
        .map(s => `<option ${s === order.status ? 'selected' : ''}>${s}</option>`).join('')}
      </select>
    `;

      container.appendChild(div);
    });

    if (highBeep) document.getElementById('highSound').play().catch(() => {
    });
    else if (beep) document.getElementById('normalSound').play().catch(() => {
    });
  }

  let selectedUserId = null;

  function filterByUser(userId) {
    selectedUserId = userId;
    loadOrders();
  }

  function clearUserFilter() {
    selectedUserId = null;
    loadOrders();
  }

  function openModal(id) {
    selectedOrderId = id;
    const box = document.getElementById('deliveryUsers');
    box.innerHTML = '';
    deliveryUsers.forEach(u => {
      const c = document.createElement('div');
      c.className = 'chip';
      c.innerText = u.name;
      c.onclick = () => acceptOrder(u.mobile);
      box.appendChild(c);
    });
    document.getElementById('acceptModal').style.display = 'flex';
  }

  function closeModal() {
    document.getElementById('acceptModal').style.display = 'none';
  }

  function closeModalOutside(e) {
    if (e.target.id === 'acceptModal') closeModal();
  }

  async function acceptOrder(user) {
    const pass = document.getElementById('adminPassword').value;
    localStorage.setItem('admin_pass', pass);
    if (!pass) return alert('Admin password required');
    await fetch(`${API}/acceptOrder/${selectedOrderId}`, {
      method: 'PATCH',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ password: pass, orderAcceptedBy: user }),
    });
    closeModal();
    loadOrders();
  }

  async function updateStatus(id, status) {
    const pass = document.getElementById('adminPassword').value;
    localStorage.setItem('admin_pass', pass);
    if (!pass) return alert('Admin password required');
    await fetch(`${API}/updateStatus/${id}`, {
      method: 'PATCH',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ password: pass, status }),
    });
    loadOrders();
  }

  function openMap(lat, lng) {
    window.open(`https://www.google.com/maps?q=${lat},${lng}`);
  }

  let wakeLock;

  async function keepScreenOn() {
    wakeLock = await navigator.wakeLock.request('screen');
  }


  loadOrders();
  keepScreenOn();
  setInterval(loadOrders, 10000);
</script>

</body>
</html>
